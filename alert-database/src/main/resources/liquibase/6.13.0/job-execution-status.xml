<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.3.xsd">
    <changeSet author="psantos" id="create-job-stage-table">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists schemaName="alert" tableName="job_stage"/>
            </not>
        </preConditions>
        <createTable schemaName="alert" tableName="job_stage">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="name" type="VARCHAR">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="psantos" id="insert-job-stages">
        <preConditions onFail="MARK_RAN">
            <or>
                <rowCount schemaName="alert" tableName="job_stage" expectedRows="0"/>
                <not>
                    <rowCount schemaName="alert" tableName="job_stage" expectedRows="5"/>
                </not>
            </or>
        </preConditions>
        <insert schemaName="alert" tableName="job_stage">
            <column name="id" value="0"/>
            <column name="name" value="NOTIFICATION_PROCESSING"/>
        </insert>
        <insert schemaName="alert" tableName="job_stage">
            <column name="id" value="1"/>
            <column name="name" value="CHANNEL_PROCESSING"/>
        </insert>
        <insert schemaName="alert" tableName="job_stage">
            <column name="id" value="2"/>
            <column name="name" value="ISSUE_CREATION"/>
        </insert>
        <insert schemaName="alert" tableName="job_stage">
            <column name="id" value="3"/>
            <column name="name" value="ISSUE_COMMENTING"/>
        </insert>
        <insert schemaName="alert" tableName="job_stage">
            <column name="id" value="4"/>
            <column name="name" value="ISSUE_RESOLVING"/>
        </insert>
    </changeSet>
    <changeSet author="psantos" id="create-job-execution-table">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists schemaName="alert" tableName="job_execution"/>
            </not>
        </preConditions>
        <createTable schemaName="alert" tableName="job_execution">
            <column name="execution_id" type="UUID" defaultValueComputed="uuid_generate_v4()">
                <constraints primaryKey="true"/>
            </column>
            <column name="job_config_id" type="UUID" defaultValueComputed="uuid_generate_v4()">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR"/>
            <column name="start_time" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="end_time" type="TIMESTAMP">
            </column>
            <column name="processed_notification_count" type="BIGINT" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="total_notification_count" type="BIGINT" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="psantos" id="create-job-execution-stage-table">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists schemaName="alert" tableName="job_execution_stage"/>
            </not>
        </preConditions>
        <createTable schemaName="alert" tableName="job_execution_stage">
            <column name="execution_id" type="UUID" defaultValueComputed="uuid_generate_v4()">
                <constraints nullable="false"/>
            </column>
            <column name="stage_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="start_time" type="TIMESTAMP">
            </column>
            <column name="end_time" type="TIMESTAMP">
            </column>
        </createTable>
        <addPrimaryKey schemaName="alert"
                       tableName="job_execution_stage"
                       columnNames="execution_id, stage_id"
                       constraintName="job-execution-stage-PK"
        />
    </changeSet>
    <changeSet author="psantos" id="create-job-execution-stage-foreign-key">
        <preConditions>
            <not>
                <foreignKeyConstraintExists schemaName="alert" foreignKeyName="job-execution-stage-fk"/>
            </not>
        </preConditions>
        <addForeignKeyConstraint
                constraintName="job-execution-stage-fk"
                baseTableSchemaName="alert"
                baseTableName="job_execution_stage"
                baseColumnNames="execution_id"
                referencedTableSchemaName="alert"
                referencedTableName="job_execution"
                referencedColumnNames="execution_id"
                onDelete="CASCADE"
        />
    </changeSet>
    <changeSet author="psantos" id="create-job-config-execution-tables-foreign-key">
        <preConditions>
            <not>
                <foreignKeyConstraintExists schemaName="alert" foreignKeyName="job-config-execution-fk"/>
            </not>
        </preConditions>
        <addForeignKeyConstraint
                constraintName="job-config-execution-fk"
                baseTableSchemaName="alert"
                baseTableName="job_execution"
                baseColumnNames="job_config_id"
                referencedTableSchemaName="alert"
                referencedTableName="distribution_jobs"
                referencedColumnNames="job_id"
                onDelete="CASCADE"
        />
    </changeSet>
    <changeSet author="psantos" id="create-job-completion-status-table">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists schemaName="alert" tableName="job_completion_status"/>
            </not>
        </preConditions>
        <createTable schemaName="alert" tableName="job_completion_status">
            <column name="job_config_id" type="UUID" defaultValueComputed="uuid_generate_v4()">
                <constraints primaryKey="true"/>
            </column>
            <column name="notification_count" type="BIGINT" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="success_count" type="BIGINT" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="failure_count" type="BIGINT" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="latest_status" type="VARCHAR"/>
            <column name="last_run" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="duration_nanoseconds" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="psantos" id="create-job-completion-stage-table">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists schemaName="alert" tableName="job_completion_stage"/>
            </not>
        </preConditions>
        <createTable schemaName="alert" tableName="job_completion_stage">
            <column name="job_config_id" type="UUID" defaultValueComputed="uuid_generate_v4()">
                <constraints nullable="false"/>
            </column>
            <column name="stage_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="duration_nanosecond" type="BIGINT"/>
        </createTable>
        <addPrimaryKey schemaName="alert"
                       tableName="job_completion_stage"
                       columnNames="job_config_id, stage_id"
                       constraintName="job-completion-stage-PK"
        />
    </changeSet>
    <changeSet author="psantos" id="create-job-stage-execution-tables-foreign-key">
        <preConditions>
            <not>
                <foreignKeyConstraintExists schemaName="alert" foreignKeyName="job-stage-execution-fk"/>
            </not>
        </preConditions>
        <addForeignKeyConstraint
                constraintName="job-stage-execution-fk"
                baseTableSchemaName="alert"
                baseTableName="job_execution_stage"
                baseColumnNames="stage_id"
                referencedTableSchemaName="alert"
                referencedTableName="job_stage"
                referencedColumnNames="id"
                onDelete="CASCADE"
        />
    </changeSet>
    <changeSet author="psantos" id="create-job-stage-completion-tables-foreign-key">
        <preConditions>
            <not>
                <foreignKeyConstraintExists schemaName="alert" foreignKeyName="job-stage-completion-fk"/>
            </not>
        </preConditions>
        <addForeignKeyConstraint
                constraintName="job-stage-completion-fk"
                baseTableSchemaName="alert"
                baseTableName="job_completion_stage"
                baseColumnNames="stage_id"
                referencedTableSchemaName="alert"
                referencedTableName="job_stage"
                referencedColumnNames="id"
                onDelete="CASCADE"
        />
    </changeSet>
    <changeSet author="psantos" id="create-completion-tables-foreign-key">
        <preConditions>
            <not>
                <foreignKeyConstraintExists schemaName="alert" foreignKeyName="job-completion-config-id-fk"/>
            </not>
        </preConditions>
        <addForeignKeyConstraint
                constraintName="job-execution-config-id-fk"
                baseTableSchemaName="alert"
                baseTableName="job_completion_stage"
                baseColumnNames="job_config_id"
                referencedTableSchemaName="alert"
                referencedTableName="job_completion_status"
                referencedColumnNames="job_config_id"
                onDelete="CASCADE"
        />
    </changeSet>
    <changeSet author="psantos" id="create-job-config-completion-tables-foreign-key">
        <preConditions>
            <not>
                <foreignKeyConstraintExists schemaName="alert" foreignKeyName="job-config-completion-status-fk"/>
            </not>
        </preConditions>
        <addForeignKeyConstraint
                constraintName="job-config-completion-status-fk"
                baseTableSchemaName="alert"
                baseTableName="job_completion_status"
                baseColumnNames="job_config_id"
                referencedTableSchemaName="alert"
                referencedTableName="distribution_jobs"
                referencedColumnNames="job_id"
                onDelete="CASCADE"
        />
    </changeSet>
</databaseChangeLog>