<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.3.xsd">
    <changeSet author="psantos" id="register-github-channel">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*)
                                         from ALERT.REGISTERED_DESCRIPTORS
                                         where NAME = 'channel_github'</sqlCheck>
        </preConditions>
        <insert schemaName="ALERT" tableName="REGISTERED_DESCRIPTORS">
            <column name="TYPE_ID" valueComputed="GET_DESCRIPTOR_TYPE_ID('CHANNEL')"/>
            <column name="NAME">channel_github</column>
        </insert>
    </changeSet>
    <!-- Initialize permissions matrix -->
    <changeSet author="psantos" id="assign-github-channel-permissions">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*)
                                         from ALERT.PERMISSION_MATRIX
                                         where ROLE_ID = GET_ROLE_ID('ALERT_ADMIN')
                                           AND DESCRIPTOR_ID = GET_DESCRIPTOR_ID('channel_github')</sqlCheck>
        </preConditions>
        <insert schemaName="ALERT" tableName="PERMISSION_MATRIX">
            <column name="ROLE_ID" valueComputed="GET_ROLE_ID('ALERT_ADMIN')"/>
            <column name="OPERATIONS">255</column>
            <column name="DESCRIPTOR_ID" valueComputed="GET_DESCRIPTOR_ID('channel_github')"/>
            <column name="CONTEXT_ID" valueComputed="GET_CONTEXT_ID('GLOBAL')"/>
        </insert>
        <insert schemaName="ALERT" tableName="PERMISSION_MATRIX">
            <column name="ROLE_ID" valueComputed="GET_ROLE_ID('ALERT_ADMIN')"/>
            <column name="OPERATIONS">255</column>
            <column name="DESCRIPTOR_ID" valueComputed="GET_DESCRIPTOR_ID('channel_github')"/>
            <column name="CONTEXT_ID" valueComputed="GET_CONTEXT_ID('DISTRIBUTION')"/>
        </insert>
                <insert schemaName="ALERT" tableName="PERMISSION_MATRIX">
            <column name="ROLE_ID" valueComputed="GET_ROLE_ID('ALERT_JOB_MANAGER')"/>
            <column name="OPERATIONS">20</column>
            <column name="DESCRIPTOR_ID" valueComputed="GET_DESCRIPTOR_ID('channel_github')"/>
            <column name="CONTEXT_ID" valueComputed="GET_CONTEXT_ID('GLOBAL')"/>
        </insert>
        <insert schemaName="ALERT" tableName="PERMISSION_MATRIX">
            <column name="ROLE_ID" valueComputed="GET_ROLE_ID('ALERT_JOB_MANAGER')"/>
            <column name="OPERATIONS">255</column>
            <column name="DESCRIPTOR_ID" valueComputed="GET_DESCRIPTOR_ID('channel_github')"/>
            <column name="CONTEXT_ID" valueComputed="GET_CONTEXT_ID('DISTRIBUTION')"/>
        </insert>
        <insert schemaName="ALERT" tableName="PERMISSION_MATRIX">
            <column name="ROLE_ID" valueComputed="GET_ROLE_ID('ALERT_USER')"/>
            <column name="OPERATIONS">4</column>
            <column name="DESCRIPTOR_ID" valueComputed="GET_DESCRIPTOR_ID('channel_github')"/>
            <column name="CONTEXT_ID" valueComputed="GET_CONTEXT_ID('DISTRIBUTION')"/>
        </insert>
    </changeSet>
    <changeSet author="psantos" id="github-register-common-fields">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*)
                                         from ALERT.DESCRIPTOR_FIELDS
                                         where FIELD_ID = GET_FIELD_ID('channel.common.name')
                                           AND DESCRIPTOR_ID = GET_DESCRIPTOR_ID('channel_github')</sqlCheck>
        </preConditions>
        <insert schemaName="ALERT" tableName="DESCRIPTOR_FIELDS">
            <column name="DESCRIPTOR_ID" valueComputed="GET_DESCRIPTOR_ID('channel_github')"/>
            <column name="FIELD_ID" valueComputed="GET_FIELD_ID('channel.common.name')"/>
        </insert>
        <insert schemaName="ALERT" tableName="DESCRIPTOR_FIELDS">
            <column name="DESCRIPTOR_ID" valueComputed="GET_DESCRIPTOR_ID('channel_github')"/>
            <column name="FIELD_ID" valueComputed="GET_FIELD_ID('channel.common.channel.name')"/>
        </insert>
        <insert schemaName="ALERT" tableName="DESCRIPTOR_FIELDS">
            <column name="DESCRIPTOR_ID" valueComputed="GET_DESCRIPTOR_ID('channel_github')"/>
            <column name="FIELD_ID" valueComputed="GET_FIELD_ID('channel.common.provider.name')"/>
        </insert>
        <insert schemaName="ALERT" tableName="DESCRIPTOR_FIELDS">
            <column name="DESCRIPTOR_ID" valueComputed="GET_DESCRIPTOR_ID('channel_github')"/>
            <column name="FIELD_ID" valueComputed="GET_FIELD_ID('channel.common.frequency')"/>
        </insert>
    </changeSet>
    <changeSet author="psantos" id="github-register-distribution-fields">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*)
                                         from ALERT.DESCRIPTOR_FIELDS
                                         where FIELD_ID = GET_FIELD_ID('github.repository.name')
                                           AND DESCRIPTOR_ID = GET_DESCRIPTOR_ID('channel_github')</sqlCheck>
        </preConditions>
        <insert schemaName="ALERT" tableName="DEFINED_FIELDS">
            <column name="SOURCE_KEY">github.repository.name</column>
            <column name="SENSITIVE">false</column>
        </insert>
        <insert schemaName="ALERT" tableName="DEFINED_FIELDS">
            <column name="SOURCE_KEY">github.pr.title.prefix</column>
            <column name="SENSITIVE">false</column>
        </insert>
        <insert schemaName="ALERT" tableName="FIELD_CONTEXTS">
            <column name="FIELD_ID" valueComputed="GET_FIELD_ID('github.repository.name')"/>
            <column name="CONTEXT_ID" valueComputed="GET_CONTEXT_ID('DISTRIBUTION')"/>
        </insert>
        <insert schemaName="ALERT" tableName="FIELD_CONTEXTS">
            <column name="FIELD_ID" valueComputed="GET_FIELD_ID('github.pr.title.prefix')"/>
            <column name="CONTEXT_ID" valueComputed="GET_CONTEXT_ID('DISTRIBUTION')"/>
        </insert>
        <insert schemaName="ALERT" tableName="DESCRIPTOR_FIELDS">
            <column name="DESCRIPTOR_ID" valueComputed="GET_DESCRIPTOR_ID('channel_github')"/>
            <column name="FIELD_ID" valueComputed="GET_FIELD_ID('github.repository.name')"/>
        </insert>
        <insert schemaName="ALERT" tableName="DESCRIPTOR_FIELDS">
            <column name="DESCRIPTOR_ID" valueComputed="GET_DESCRIPTOR_ID('channel_github')"/>
            <column name="FIELD_ID" valueComputed="GET_FIELD_ID('github.pr.title.prefix')"/>
        </insert>
    </changeSet>
</databaseChangeLog>